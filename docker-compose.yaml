version: '3.8'

services:
  # The main FastAPI application service
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pdf_vectorizer_app
    # Pass environment variables from the .env file
    env_file:
      - .env
    ports:
      - "8000:8000"
    # Ensure the app starts after its dependencies are healthy
    depends_on:
      qdrant:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - vectorizer_net
    restart: unless-stopped

  # Qdrant vector database service
  qdrant:
    image: qdrant/qdrant:v1.10.1 # Pinning version for stability
    container_name: pdf_vectorizer_qdrant
    ports:
      - "6333:6333"
      - "6334:6334" # gRPC port
    volumes:
      - qdrant_storage:/qdrant/storage
    networks:
      - vectorizer_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # MinIO object storage service
  minio:
    image: minio/minio:RELEASE.2024-07-25T08-37-29Z # Pinning version for stability
    container_name: pdf_vectorizer_minio
    # Environment variables are loaded from the .env file for consistency
    env_file:
      - .env
    ports:
      - "${MINIO_PORT:-9000}:9000"       # API port
      - "${MINIO_CONSOLE_PORT:-9001}:9001" # Console port
    volumes:
      - minio_storage:/data
    command: server /data --console-address ":9001"
    networks:
      - vectorizer_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

# Define the shared network for inter-service communication
networks:
  vectorizer_net:
    driver: bridge

# Define the persistent volumes for data storage
volumes:
  qdrant_storage:
  minio_storage:
